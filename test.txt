#Test basic language features


###
LET rate = 0.10
LET growth = 0.08

SCENARIO Bull
   LET rate = 0.09
   LET growth = 0.12

SCENARIO Bear
   LET rate = 0.13
   LET growth = 0.03

RUN Bull ON valuation_model
RUN Bear ON valuation_model

Test string slicing/subscript:
LET s = "string"
PRINT s[0] # "s"
PRINT s[0:2] # "st"
LET t = s[0:1] + "k" + s[2:]
PRINT t # "skring"

#Test finance calls (NPV/IRR/PV):
PRINT NPV([-100, 60, 60], 0.1)

PRINT IRR([-100, 60, 60])

#Test TABLE and column access:

LET tbl = TABLE(
year: [2020, 2021, 2022],
sales: [200, 134, 145]
)
PRINT tbl.sales

PRINT len(tbl.sales)

#Test MAP/AGGREGATE:
LET vals = [1, 2, 3, 4]
PRINT MAP(vals, len)

PRINT AGGREGATE(vals, "SUM")

#using finance functions
PRINT NPV([-100, 60, 60], 0.1)

PRINT IRR([-100, 60, 60])

PRINT CAPM(0.8, 0.02, 0.08)

#using lambda:
LET sales = [1, 2, 3, 4]
LET total_sales = MAP(sales, x -> x * x)
PRINT total_sales

LET people = [
{ name: "Ana", age: 17 },
{ name: "Ben", age: 22 },
{ name: "Carlo", age: 30 },
{ name: "Dana", age: 15 }
]

# Test REDUCE: numeric sum (no initial)
LET nums = [5, 10, 3, 7]
LET sum = REDUCE(nums, (a, x) -> a + x)
PRINT sum

# Test REDUCE: product with initial value
LET product = REDUCE([2, 3, 4], (a, x) -> a * x, 1)
PRINT product

# Test REDUCE: string concatenation
LET words = ["Hello", "World", "!"]
LET sentence = REDUCE(words, (a, x) -> a + " " + x)
PRINT sentence

# Test REDUCE: building a sum with initial offset
LET offset_sum = REDUCE([1, 2, 3], (a, x) -> a + x, 100)
PRINT offset_sum

LET people = [
    { name: "Ana", age: 17 },
    { name: "Ben", age: 22 },
    { name: "Carl", age: 30 }
]

LET adults = FILTER(people, p -> p.age >= 18)
LET names = MAP(adults, p -> p.name)

PRINT names

LET nums = [1, 2, 3, 4]
LET total = REDUCE(nums, 0, (a, x) -> a + x)
PRINT total

LET nums = [1, 2, 3, 4, 5, 6]
LET evens = FILTER(nums, x -> x % 2 == 0)
PRINT evens

LET x = 10
LET f = (y -> x + y)
LET x = 50
PRINT f(5)


LET makeAdder = (a -> (b -> a + b))
LET add5 = makeAdder(5)
PRINT add5(10)

LET values = [1, 2, 3, 4]
LET squared = MAP(values, x -> x * x)
PRINT squared

LET add = (a, b) -> a + b
PRINT add(3, 7)

LET f = (x -> x + 1)
PRINT f(5)

LET nums = [1, 2, 3]

LET makeMultiplier = (factor -> (x -> x * factor))

LET result = MAP(nums, makeMultiplier(10))
PRINT result

LET x = 10
LET f = (a -> a + x)
PRINT MAP([1, 2, 3], f)

LET makeAdder = (x -> (y -> x + y))
LET add5 = makeAdder(5)
PRINT add5(10)

LET numbers = [3, 10, 7, 2, 18, 5]
PRINT FILTER(numbers, n -> n % 2 == 0 || n > 15)

LET nums = [1, 2, 3, 4]
LET r = REDUCE(nums, (a, x) -> a * x, 1)
PRINT r

LET words = ["a", "b", "c"]
PRINT REDUCE(words, (a, x) -> a + x, "")

LET values = [1, "hello", true]
PRINT MAP(values, v -> v)

LET t = [
    { name: "A", price: 100 },
    { name: "B", price: 200 }
]

PRINT MAP(t, r -> r.price * 2)

LET employees = [
   { name: "Ken", salary: 3000 },
   { name: "Mia", salary: 5000 }
]

LET raised = MAP(employees, e -> {name: e.name, salary: e.salary + 500})

PRINT raised


FUNC applyTwice(fn, x) {
    return fn(fn(x))
}

PRINT applyTwice((y -> y * 2), 5)

LET x = 100

FUNC addX(v) {
    return v + x
}

PRINT addX(5)

PRINT MAP([1, 2, 3], x -> MAP([10, 20], y -> x + y))

LET annual = 0.06
LET monthlyRate = annual / 12
LET months = 1 * 12

LET sched = AMORTIZE(100000, monthlyRate, months)
PRINT "whole column of payments"

PRINT sched.payment       # whole column of payments

PRINT "first payment"

PRINT sched.payment[0]    # first payment

PRINT "first interest amount"

PRINT sched.interest[0]   # first interest amount

PRINT "first principal portion"

PRINT sched.principal[0]  # first principal portion

PRINT "final balance"

PRINT sched.balance[months - 1]  # final balance (should be 0 or near 0)

PRINT "Portfolio as object with assets and weights"
LET assets = [0.12, 0.09, 0.15, 0.08]
LET weights = [0.40, 0.30, 0.20, 0.10]
LET portfolio = { assets: assets, weights: weights }

PRINT portfolio

PRINT "Value at Risk calculation on returns"
LET returns = [0.05, 0.03, 0.04, 0.06, 0.02]
LET varResult = VAR(returns, 0.95)
PRINT varResult

PRINT "SMA (Simple Moving Average)"
LET prices = [100, 102, 101, 103, 105, 104, 106, 108]
LET sma3 = SMA(prices, 3)
PRINT sma3

PRINT "EMA (Exponential Moving Average)"
LET ema3 = EMA(prices, 3)
PRINT ema3

PRINT "Portfolio as native block"
PORTFOLIO myPortfolio:
    DEBIT cash 0.12
    DEBIT stocks 0.09
    DEBIT bonds 0.15
    DEBIT real_estate 0.08
    CREDIT liabilities 0.40
    CREDIT equity 0.30
    CREDIT income 0.20
    CREDIT other 0.10
END
PRINT myPortfolio

PRINT "Single asset portfolio"
PORTFOLIO singleAsset:
    DEBIT cash 100.0
END
PRINT singleAsset

PRINT "Portfolio with only credits"
PORTFOLIO onlyCredits:
    CREDIT liabilities 50.0
    CREDIT equity 50.0
END
PRINT onlyCredits

PRINT "Portfolio with only debits"
PORTFOLIO onlyDebits:
    DEBIT cash 20.0
    DEBIT stocks 80.0
END
PRINT onlyDebits

PRINT "Portfolio assignment and reuse"
PORTFOLIO p1:
    DEBIT cash 10.0
    CREDIT equity 10.0
END
PRINT p1

PRINT "TIMESERIES - Moving Average with window size 3"
LET data = [10, 20, 30, 40, 50, 60]
LET ts = TIMESERIES(data, 3)
PRINT ts


PRINT "Monthly stock prices over 12 months"

LET prices = [100, 102, 98, 105, 103, 107, 106, 110, 108, 112, 115, 118]

PRINT "Raw prices:"

PRINT prices

PRINT "3-month moving average:"

LET ma3 = TIMESERIES(prices, 3)
PRINT ma3

PRINT "6-month moving average:"

LET ma6 = TIMESERIES(prices, 6)
PRINT ma6

PRINT "Increment/Decrement Tests"
LET x = 5
INC x
PRINT x
LET y = 10
INC y
PRINT y
LET a = 3
DEC a
PRINT a
LET b = 8
DEC b
PRINT b


PRINT "1. Variables"
LET x = 10
LET y = 20
SET x = 15
PRINT "x =", x
PRINT "y =", y

PRINT "2. Functions with Closures"
FUNC addx(a) {
    FUNC adder(b) {
        RETURN a + b
    }
    RETURN adder
}
LET add5 = addx(5)
PRINT add5(10)

 PRINT "3. Financial Functions"
PRINT NPV([-100, 60, 60], 0.1)
PRINT IRR([-100, 60, 60])
PRINT AMORTIZE(100000, 0.05, 5).payment[0]

PRINT "4. TIMESERIES"
LET data = [10, 20, 30, 40, 50]
LET ts = TIMESERIES(data, 2)
PRINT ts

PRINT "5. Portfolio"
PORTFOLIO p:
    DEBIT assets 100
    CREDIT liabilities 50
END
PRINT p

PRINT "1. Variables"
LET x = 10
LET y = 20
SET x = 15
PRINT "x =", x
PRINT "y =", y

PRINT "2. Functions with Closures"
FUNC addx(a) {
    FUNC adder(b) {
        RETURN a + b
    }
    RETURN adder
}
LET add5 = addx(5)
PRINT add5(10)

 PRINT "3. Financial Functions"
PRINT NPV([-100, 60, 60], 0.1)
PRINT IRR([-100, 60, 60])
PRINT AMORTIZE(100000, 0.05, 5).payment[0]

PRINT "4. TIMESERIES"
LET data = [10, 20, 30, 40, 50]
LET ts = TIMESERIES(data, 2)
PRINT ts

PRINT "5. Portfolio"
PORTFOLIO p:
    DEBIT assets 100
    CREDIT liabilities 50
END
PRINT p

# Ledger / Cashflow test

PRINT "Cashflow / Ledger test"

LET cf = [100, 200, -50]

PRINT cf                # prints a list representing cashflows

PRINT NPV(cf, 0.1)      # compute NPV on the cashflow list

PRINT "Portfolio-as-ledger test"

PORTFOLIO acct:
    DEBIT cash 100.0
    CREDIT equity 100.0
END
PRINT acct              # prints the Portfolio / or LEDGER representation stored


# Historical stock prices
LET stock_prices = [100, 102, 98, 105, 103, 107, 106, 110, 108, 112]

# Monthly returns
LET monthly_returns = [0.02, -0.04, 0.07, -0.02, 0.04, -0.01, 0.04, -0.02, 0.04]

# Portfolio allocation
LET portfolio_assets = [0.40, 0.30, 0.20, 0.10]
LET portfolio_weights = [0.40, 0.30, 0.20, 0.10]

# Risk-free rate and market premium
LET risk_free_rate = 0.02
LET market_premium = 0.08

# Sample betas for assets
LET asset_betas = [1.2, 0.9, 1.1, 0.7]

PRINT "data.finlite loaded"

PRINT "Test 1: Load data module"
IMPORT "data.finlite" AS data
PRINT "Data module imported"

PRINT "Test 2: Load helper module"
IMPORT "helpers.finlite" AS helpers
PRINT "Helpers module imported"

PRINT "Test 3: Use imported data"
LET prices = [100, 102, 98, 105, 103, 107]
PRINT "Stock prices loaded"
PRINT prices

PRINT "Test 4: Calculate returns using helper logic"
LET initial = 100
LET final = 115
LET ret_pct = ((final - initial) / initial) * 100
PRINT "Return percentage:"
PRINT ret_pct

PRINT "Test 5: Compound interest calculation"
LET principal = 10000
LET rate = 0.05
LET years = 5
LET future_value = principal * ((1 + rate) ^ years)
PRINT "Future value after 5 years at 5%:"
PRINT future_value

PRINT "Test 6: Portfolio analysis"
LET assets = [100, 80, 60, 40]
LET total = sum(assets)
PRINT "Total portfolio value:"
PRINT total
LET num_assets = len(assets)
PRINT "Number of assets:"
PRINT num_assets

PRINT "Test 7: CAPM calculation with beta"
LET beta = 1.2
LET rf = 0.02
LET premium = 0.08
LET required_return = CAPM(beta, rf, premium)
PRINT "Required return (CAPM):"
PRINT required_return

# Calculate compound interest
FUNC compound_interest(principal, rate, years) {
    RETURN principal * ((1 + rate) ^ years)
}

# Calculate simple return percentage
FUNC return_pct(initial, final) {
    RETURN ((final - initial) / initial) * 100
}

# Calculate annualized return
FUNC annualized_return(total_return, years) {
    RETURN ((1 + total_return) ^ (1 / years)) - 1
}

# Portfolio rebalance helper - average the weights
FUNC avg_weight(weights) {
    RETURN 1 / len(weights)
}

PRINT "helpers.finlite loaded"
###
