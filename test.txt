###
LET rate = 0.10
LET growth = 0.08

SCENARIO Bull
   LET rate = 0.09
   LET growth = 0.12

SCENARIO Bear
   LET rate = 0.13
   LET growth = 0.03

RUN Bull ON valuation_model
RUN Bear ON valuation_model

Test string slicing/subscript:
LET s = "string"
PRINT s[0] # "s"
PRINT s[0:2] # "st"
LET t = s[0:1] + "k" + s[2:]
PRINT t # "skring"

#Test finance calls (NPV/IRR/PV):
PRINT NPV([-100, 60, 60], 0.1)

PRINT IRR([-100, 60, 60])

#Test TABLE and column access:

LET tbl = TABLE(
year: [2020, 2021, 2022],
sales: [200, 134, 145]
)
PRINT tbl.sales

PRINT len(tbl.sales)

#Test MAP/AGGREGATE:
LET vals = [1, 2, 3, 4]
PRINT MAP(vals, len)

PRINT AGGREGATE(vals, "SUM")

#using finance functions
PRINT NPV([-100, 60, 60], 0.1)

PRINT IRR([-100, 60, 60])

PRINT CAPM(0.8, 0.02, 0.08)


#using lambda:
LET sales = [1, 2, 3, 4]
LET total_sales = MAP(sales, x -> x * x)
PRINT total_sales

LET people = [
{ name: "Ana", age: 17 },
{ name: "Ben", age: 22 },
{ name: "Carlo", age: 30 },
{ name: "Dana", age: 15 }
]

# Test REDUCE: numeric sum (no initial)
LET nums = [5, 10, 3, 7]
LET sum = REDUCE(nums, (a, x) -> a + x)
PRINT sum

# Test REDUCE: product with initial value
LET product = REDUCE([2, 3, 4], (a, x) -> a * x, 1)
PRINT product

# Test REDUCE: string concatenation
LET words = ["Hello", "World", "!"]
LET sentence = REDUCE(words, (a, x) -> a + " " + x)
PRINT sentence

# Test REDUCE: building a sum with initial offset
LET offset_sum = REDUCE([1, 2, 3], (a, x) -> a + x, 100)
PRINT offset_sum

LET people = [
    { name: "Ana", age: 17 },
    { name: "Ben", age: 22 },
    { name: "Carl", age: 30 }
]

LET adults = FILTER(people, p -> p.age >= 18)
LET names = MAP(adults, p -> p.name)

PRINT names

LET nums = [1, 2, 3, 4]
LET total = REDUCE(nums, 0, (a, x) -> a + x)
PRINT total

LET nums = [1, 2, 3, 4, 5, 6]
LET evens = FILTER(nums, x -> x % 2 == 0)
PRINT evens

LET x = 10
LET f = (y -> x + y)
LET x = 50
PRINT f(5)


LET makeAdder = (a -> (b -> a + b))
LET add5 = makeAdder(5)
PRINT add5(10)

LET values = [1, 2, 3, 4]
LET squared = MAP(values, x -> x * x)
PRINT squared

LET add = (a, b) -> a + b
PRINT add(3, 7)

LET f = (x -> x + 1)
PRINT f(5)

LET nums = [1, 2, 3]

LET makeMultiplier = (factor -> (x -> x * factor))

LET result = MAP(nums, makeMultiplier(10))
PRINT result

LET x = 10
LET f = (a -> a + x)
PRINT MAP([1, 2, 3], f)

LET makeAdder = (x -> (y -> x + y))
LET add5 = makeAdder(5)
PRINT add5(10)

LET numbers = [3, 10, 7, 2, 18, 5]
PRINT FILTER(numbers, n -> n % 2 == 0 || n > 15)

LET nums = [1, 2, 3, 4]
LET r = REDUCE(nums, (a, x) -> a * x, 1)
PRINT r

LET words = ["a", "b", "c"]
PRINT REDUCE(words, (a, x) -> a + x, "")

LET values = [1, "hello", true]
PRINT MAP(values, v -> v)

LET t = [
    { name: "A", price: 100 },
    { name: "B", price: 200 }
]

PRINT MAP(t, r -> r.price * 2)

LET employees = [
   { name: "Ken", salary: 3000 },
   { name: "Mia", salary: 5000 }
]

LET raised = MAP(employees, e -> {name: e.name, salary: e.salary + 500})

PRINT raised


FUNC applyTwice(fn, x) {
    return fn(fn(x))
}

PRINT applyTwice((y -> y * 2), 5)

LET x = 100

FUNC addX(v) {
    return v + x
}

PRINT addX(5)

PRINT MAP([1, 2, 3], x -> MAP([10, 20], y -> x + y))

LET annual = 0.06
LET monthlyRate = annual / 12
LET months = 1 * 12

LET sched = AMORTIZE(100000, monthlyRate, months)
PRINT "whole column of payments"

PRINT sched.payment       # whole column of payments

PRINT "first payment"

PRINT sched.payment[0]    # first payment

PRINT "first interest amount"

PRINT sched.interest[0]   # first interest amount

PRINT "first principal portion"

PRINT sched.principal[0]  # first principal portion

PRINT "final balance"

PRINT sched.balance[months - 1]  # final balance (should be 0 or near 0)

###
PRINT "Portfolio as object with assets and weights"
LET assets = [0.12, 0.09, 0.15, 0.08]
LET weights = [0.40, 0.30, 0.20, 0.10]
LET portfolio = { assets: assets, weights: weights }

PRINT portfolio

PRINT "Value at Risk calculation on returns"
LET returns = [0.05, 0.03, 0.04, 0.06, 0.02]
LET varResult = VAR(returns, 0.95)
PRINT varResult

PRINT "SMA (Simple Moving Average)"
LET prices = [100, 102, 101, 103, 105, 104, 106, 108]
LET sma3 = SMA(prices, 3)
PRINT sma3

PRINT "EMA (Exponential Moving Average)"
LET ema3 = EMA(prices, 3)
PRINT ema3

PRINT "Portfolio as native block"
PORTFOLIO myPortfolio:
    DEBIT cash 0.12
    DEBIT stocks 0.09
    DEBIT bonds 0.15
    DEBIT real_estate 0.08
    CREDIT liabilities 0.40
    CREDIT equity 0.30
    CREDIT income 0.20
    CREDIT other 0.10
END
PRINT myPortfolio

PRINT "Single asset portfolio"
PORTFOLIO singleAsset:
    DEBIT cash 100.0
END
PRINT singleAsset

PRINT "Portfolio with only credits"
PORTFOLIO onlyCredits:
    CREDIT liabilities 50.0
    CREDIT equity 50.0
END
PRINT onlyCredits

PRINT "Portfolio with only debits"
PORTFOLIO onlyDebits:
    DEBIT cash 20.0
    DEBIT stocks 80.0
END
PRINT onlyDebits

PRINT "Portfolio assignment and reuse"
PORTFOLIO p1:
    DEBIT cash 10.0
    CREDIT equity 10.0
END
PRINT p1
###